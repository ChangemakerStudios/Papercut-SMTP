# Windows Package Manager (winget) Manifests

This directory contains template manifest files for publishing Papercut SMTP to the [Windows Package Manager](https://github.com/microsoft/winget-pkgs) (winget).

## Overview

Winget allows users to install and update Papercut using simple commands:
```powershell
winget install ChangemakerStudios.PapercutSMTP
winget upgrade ChangemakerStudios.PapercutSMTP
```

## Automated Publishing

Papercut SMTP uses an **automated workflow** to publish to winget when stable releases are created from the master branch.

### How It Works

1. **Cake Build Task** (`PrepareWinGetRelease` in [build.cake](../../build.cake#L430))
   - Automatically runs during master branch builds
   - Uses [build/WinGet.cake](../../build/WinGet.cake) module with Cake.Yaml for proper YAML serialization
   - Calculates SHA256 hashes from all Setup.exe installers
   - Generates three manifest YAML files in `releases/winget/` using strongly-typed C# models
   - Uploads manifests to GitHub release as assets
   - Only runs for master branch (stable releases)

2. **GitHub Actions Workflow** ([winget-publish.yml](../../.github/workflows/winget-publish.yml))
   - Triggers automatically when a stable release is published from master
   - Downloads the three manifest files from the GitHub release (generated by Cake)
   - Validates manifests using winget CLI
   - Uploads manifests as workflow artifacts (for manual fallback)
   - Creates a PR to the microsoft/winget-pkgs repository (if configured)

### Setup Requirements

To enable automatic PR creation to winget-pkgs, configure the following:

#### 1. Fork the winget-pkgs repository
```
Fork: https://github.com/microsoft/winget-pkgs
```

#### 2. Create a GitHub Personal Access Token (PAT)
- Go to GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)
- Generate new token with the following scopes:
  - **Contents**: Read and write
  - **Pull requests**: Read and write
  - **Workflows**: Read and write (optional)
- Copy the token

#### 3. Add Repository Secrets
- Go to repository Settings → Secrets and variables → Actions
- Add secret: `WINGET_PUBLISH_TOKEN` = your PAT
- Add secret: `WINGET_PKGS_FORK` = `YourGitHubUsername/winget-pkgs` (optional, defaults to ChangemakerStudios/winget-pkgs)

### Manual Trigger

You can also manually trigger the winget publishing workflow:

```bash
# Via GitHub CLI
gh workflow run winget-publish.yml --ref master -f version=7.5.0

# Or use the GitHub Actions UI and select "Run workflow"
```

### What Happens Automatically

**During the build (master branch only):**
1. ✅ Cake build runs `PrepareWinGetRelease` task
2. ✅ Calculates SHA256 hashes from all Setup.exe files (x64, x86, arm64)
3. ✅ Generates three manifest YAML files using Cake.Yaml
4. ✅ Uploads manifests to GitHub release

**When a stable release is published from master:**
1. ✅ GitHub Actions workflow is triggered
2. ✅ Downloads the three manifest YAML files from the release
3. ✅ Validates manifests with winget CLI
4. ✅ Uploads manifests as workflow artifacts
5. ✅ Creates PR to microsoft/winget-pkgs (if `WINGET_PUBLISH_TOKEN` is configured)

If the token is not configured, you can download the manifests from either the release assets or workflow artifacts and submit manually.

## Manifest Files

The files in this directory are templates. The actual manifests are generated during the build/release process.

- **ChangemakerStudios.PapercutSMTP.yaml** - Version file template
- **ChangemakerStudios.PapercutSMTP.locale.en-US.yaml** - Locale file template (metadata, description, license)
- **ChangemakerStudios.PapercutSMTP.installer.yaml** - Installer file template (URLs, SHA256 hashes - placeholders only)

## Manual Submission Process

If automated publishing is not configured, you can manually submit to winget:

### Prerequisites

1. Install the Windows Package Manager Manifest Creator:
   ```powershell
   winget install Microsoft.WingetCreate
   ```

2. Fork the [microsoft/winget-pkgs](https://github.com/microsoft/winget-pkgs) repository

### Steps for New Version Release

#### Option A: Download from Workflow Artifacts (Easiest)

1. Go to the GitHub Actions run for your release
2. Download the `winget-manifests-X.Y.Z` artifact
3. Extract the three YAML files
4. Fork/clone microsoft/winget-pkgs
5. Copy files to: `manifests/c/ChangemakerStudios/PapercutSMTP/<version>/`
6. Create a PR

#### Option B: Use wingetcreate Tool

```powershell
$version = "7.5.0"
wingetcreate update ChangemakerStudios.PapercutSMTP `
  --version $version `
  --urls `
    "https://github.com/ChangemakerStudios/Papercut-SMTP/releases/download/$version/PapercutSMTP-win-x64-stable-Setup.exe" `
    "https://github.com/ChangemakerStudios/Papercut-SMTP/releases/download/$version/PapercutSMTP-win-x86-stable-Setup.exe" `
    "https://github.com/ChangemakerStudios/Papercut-SMTP/releases/download/$version/PapercutSMTP-win-arm64-stable-Setup.exe" `
  --submit
```

#### Option C: Manual Process

1. Update all three YAML files with the new version
2. Download installers and calculate SHA256 hashes:
   ```powershell
   Get-FileHash "PapercutSMTP-win-x64-stable-Setup.exe" -Algorithm SHA256
   Get-FileHash "PapercutSMTP-win-x86-stable-Setup.exe" -Algorithm SHA256
   Get-FileHash "PapercutSMTP-win-arm64-stable-Setup.exe" -Algorithm SHA256
   ```
3. Update `InstallerSha256` values in installer.yaml
4. Validate locally: `winget install --manifest .`
5. Submit PR to microsoft/winget-pkgs

## Velopack Installer Details

Papercut uses [Velopack](https://velopack.io) for packaging, which produces Setup.exe installers that support:
- Silent installation: `--silent` flag
- User-scoped installation to `%LocalAppData%\PapercutSMTP`
- Automatic desktop and start menu shortcuts
- Built-in update mechanism

These installers are fully compatible with winget's EXE installer type.

## Local Testing

You can test the manifest generation locally:

```powershell
# Run just the WinGet manifest generation (requires master branch)
.\build.ps1 --target=PrepareWinGetRelease

# Or run dotnet-cake directly
dotnet-cake --target=PrepareWinGetRelease
```

The manifests will be generated in `releases/winget/` and you can inspect them before the build completes.

## Troubleshooting

### Workflow fails with "WINGET_PUBLISH_TOKEN not set"

This is expected if you haven't configured the secret. The workflow will:
- ✅ Still download and validate manifests from release
- ✅ Upload manifests as artifacts
- ❌ Skip automatic PR creation

Download the artifacts and submit manually, or configure the token.

### Workflow fails with "Failed to download manifest files"

This means the manifests weren't uploaded to the release. Check:
- The release was created from the **master** branch (PrepareWinGetRelease only runs on master)
- The Cake build task `PrepareWinGetRelease` ran successfully (check build logs)
- The `DeployReleases` task uploaded the manifest files to the release

### Manifest validation fails

Check:
- All three architecture installers exist in the release
- URLs are correct and accessible
- SHA256 hashes match the downloaded files
- YAML syntax is valid (indentation matters!)

### PR is rejected by microsoft/winget-pkgs

Common issues:
- Package already exists with same version
- Manifest format doesn't match schema
- Installer URLs are not publicly accessible
- Automated validation tests fail

Check the PR feedback and adjust manifests accordingly.

## Resources

- [Windows Package Manager Documentation](https://learn.microsoft.com/en-us/windows/package-manager/)
- [Creating Manifests](https://learn.microsoft.com/en-us/windows/package-manager/package/manifest)
- [winget-pkgs Repository](https://github.com/microsoft/winget-pkgs)
- [Manifest Schema Reference](https://github.com/microsoft/winget-cli/blob/master/doc/windows/package-manager/package/manifest.md)
- [Velopack Documentation](https://docs.velopack.io)
- [Papercut Build Script](../../build.cake)
- [Papercut Winget Workflow](../../.github/workflows/winget-publish.yml)
